<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Habit Grid</title>
  <style>
    :root{
      --bg: #0b0f17;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --line: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --good: #2ee59d;
      --mid:  #ffd166;
      --bad:  #ff5c7a;
      --accent:#7c5cff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --sq: 14px;
      --gap: 6px;
      color-scheme: dark;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(124,92,255,.28), transparent 60%),
                  radial-gradient(800px 500px at 110% 10%, rgba(46,229,157,.18), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    header{
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 16px 16px 10px;
      background: linear-gradient(to bottom, rgba(11,15,23,.92), rgba(11,15,23,.65), transparent);
      backdrop-filter: blur(10px);
    }
    .title{
      display:flex; align-items:baseline; justify-content:space-between;
      gap: 12px;
    }
    h1{ margin:0; font-size: 20px; letter-spacing:.2px; }
    .sub{ margin:6px 0 0; color: var(--muted); font-size: 13px; }

    main{ padding: 10px 14px 96px; }

    .gallery{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 14px 14px 10px;
    }
    .cardTitle{
      display:flex; flex-direction:column; gap: 2px;
      min-width: 0;
    }
    .nameRow{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .habitName{
      font-size: 16px;
      font-weight: 650;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 62vw;
    }
    .pill{
      font-size: 11px;
      color: rgba(255,255,255,.75);
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      padding: 4px 8px;
      border-radius: 999px;
      flex: 0 0 auto;
    }
    .meta{
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }
    .actions{
      display:flex;
      gap: 8px;
      flex: 0 0 auto;
    }
    button{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: translateY(1px); }
    .primary{
      border-color: rgba(124,92,255,.45);
      background: rgba(124,92,255,.18);
    }
    .danger{
      border-color: rgba(255,92,122,.35);
      background: rgba(255,92,122,.12);
      color: rgba(255,255,255,.88);
    }

    .gridWrap{
      padding: 0 14px 14px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(30, var(--sq));
      gap: var(--gap);
      align-content: start;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .sq{
      width: var(--sq);
      height: var(--sq);
      border-radius: 4px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.06);
      cursor: pointer;
    }
    .sq[data-level="0"]{ background: rgba(255,255,255,.06); }
    .sq[data-level="1"]{ background: rgba(255,92,122,.40); border-color: rgba(255,92,122,.25); }
    .sq[data-level="2"]{ background: rgba(255,209,102,.45); border-color: rgba(255,209,102,.25); }
    .sq[data-level="3"]{ background: rgba(46,229,157,.55); border-color: rgba(46,229,157,.28); }
    .sqToday{
      outline: 2px solid rgba(124,92,255,.55);
      outline-offset: 1px;
    }

    .fabBar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 12px 14px calc(12px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(11,15,23,.92), rgba(11,15,23,.65), transparent);
      backdrop-filter: blur(10px);
    }
    .fab{
      width: 100%;
      display:flex;
      justify-content:center;
    }
    .fab button{
      width: min(520px, 100%);
      padding: 14px 16px;
      border-radius: 16px;
      font-size: 15px;
      background: linear-gradient(135deg, rgba(124,92,255,.30), rgba(46,229,157,.18));
      border: 1px solid rgba(255,255,255,.18);
    }

    /* Modal */
    .modalBack{
      position: fixed;
      inset: 0;
      display:none;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index: 50;
      padding: 16px;
      align-items: flex-end;
    }
    .modal{
      width: min(600px, 100%);
      margin: 0 auto;
      background: rgba(18,24,36,.96);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
    }
    .modalTitle{ font-weight: 750; }
    .modalBody{ padding: 14px; display:flex; flex-direction:column; gap: 10px; }
    label{ font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-size: 15px;
      outline: none;
    }
    textarea{ min-height: 90px; resize: vertical; }
    .row{ display:flex; gap: 10px; }
    .row > div{ flex:1; }
    .modalFoot{
      padding: 12px 14px 14px;
      display:flex;
      gap: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .modalFoot button{ flex:1; }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <h1>Habit Grid</h1>
      <div class="pill" id="todayPill"></div>
    </div>
    <div class="sub">Tap a square to log that day. Or use “Log yesterday”. Data saves on this device.</div>
  </header>

  <main>
    <div class="gallery" id="gallery"></div>
  </main>

  <div class="fabBar">
    <div class="fab">
      <button class="primary" id="addBtn">＋ Add habit</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle" id="modalTitle">Add habit</div>
        <button id="closeModal">Close</button>
      </div>

      <div class="modalBody" id="modalBody"></div>

      <div class="modalFoot">
        <button id="secondaryBtn">Cancel</button>
        <button class="primary" id="primaryBtn">Save</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "habit_grid_v1";

  /*** Utilities ***/
  const pad2 = n => String(n).padStart(2,'0');
  const ymd = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseYMD = (s) => {
    const [y,m,da] = s.split("-").map(Number);
    const d = new Date(y, m-1, da);
    d.setHours(12,0,0,0);
    return d;
  };
  const daysAgo = (n) => {
    const d = new Date();
    d.setHours(12,0,0,0);
    d.setDate(d.getDate() - n);
    return d;
  };
  const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));

  /*** State ***/
  const state = load() || seed();

  function seed(){
    return {
      habits: [
        // sample:
        // { id: crypto.randomUUID(), name:"Water", type:"num", target:8, createdAt: Date.now(), logs: { "2026-01-01": 5 }, notes:{} }
      ]
    };
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(e){
      console.warn("Load failed", e);
      return null;
    }
  }
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  /*** UI Elements ***/
  const gallery = document.getElementById("gallery");
  const today = new Date(); today.setHours(12,0,0,0);
  document.getElementById("todayPill").textContent = `Today: ${ymd(today)}`;

  // Modal
  const modalBack = document.getElementById("modalBack");
  const modalBody = document.getElementById("modalBody");
  const modalTitle = document.getElementById("modalTitle");
  const primaryBtn = document.getElementById("primaryBtn");
  const secondaryBtn = document.getElementById("secondaryBtn");
  const closeModal = document.getElementById("closeModal");

  let modalMode = null; // 'add' | 'log'
  let modalCtx = null;  // habit/date

  function openModal({title, bodyHTML, onPrimary, primaryText="Save", secondaryText="Cancel", onSecondary}){
    modalTitle.textContent = title;
    modalBody.innerHTML = bodyHTML;
    primaryBtn.textContent = primaryText;
    secondaryBtn.textContent = secondaryText;

    primaryBtn.onclick = () => onPrimary?.();
    secondaryBtn.onclick = () => { onSecondary?.(); close(); };
    closeModal.onclick = () => close();

    modalBack.style.display = "flex";
  }
  function close(){
    modalBack.style.display = "none";
    modalBody.innerHTML = "";
    modalMode = null;
    modalCtx = null;
  }
  modalBack.addEventListener("click", (e) => {
    if(e.target === modalBack) close();
  });

  /*** Rendering ***/
  const WINDOW_DAYS = 90; // last 3ish months

  function getLevelForHabitSquare(habit, dateStr){
    const v = habit.logs?.[dateStr];
    if(habit.type === "yn"){
      if(v === true) return 3;      // done
      if(v === false) return 1;     // explicitly "no"
      return 0;                     // empty
    } else {
      // numeric scaling: 0=empty, 1=low,2=mid,3=hit target+
      if(v === undefined || v === null || v === "") return 0;
      const num = Number(v);
      if(Number.isNaN(num)) return 0;
      if(!habit.target || habit.target <= 0){
        // no target: just treat >0 as mid/good
        return num <= 0 ? 1 : 3;
      }
      const ratio = num / habit.target;
      if(ratio <= 0) return 1;
      if(ratio < 0.6) return 1;
      if(ratio < 1.0) return 2;
      return 3;
    }
  }

  function computeStreak(habit){
    // streak = consecutive days up to today where "done" (yn=true, num>=target)
    let s = 0;
    for(let i=0; i<3650; i++){
      const d = daysAgo(i);
      const key = ymd(d);
      const v = habit.logs?.[key];

      let done = false;
      if(habit.type === "yn"){
        done = (v === true);
      } else {
        const num = Number(v);
        if(Number.isFinite(num)){
          done = habit.target ? (num >= habit.target) : (num > 0);
        }
      }
      if(done) s++;
      else break;
    }
    return s;
  }

  function render(){
    gallery.innerHTML = "";
    if(state.habits.length === 0){
      gallery.innerHTML = `
        <div class="card">
          <div class="cardTop">
            <div class="cardTitle">
              <div class="habitName">No habits yet</div>
              <div class="meta">Tap “＋ Add habit” to create your first one.</div>
            </div>
          </div>
        </div>
      `;
      return;
    }

    for(const habit of state.habits){
      const streak = computeStreak(habit);
      const card = document.createElement("div");
      card.className = "card";

      const typePill = habit.type === "yn" ? "Yes/No" : `Numeric${habit.target ? " · target " + habit.target : ""}`;

      card.innerHTML = `
        <div class="cardTop">
          <div class="cardTitle">
            <div class="nameRow">
              <div class="habitName" title="${escapeHtml(habit.name)}">${escapeHtml(habit.name)}</div>
              <div class="pill">${typePill}</div>
            </div>
            <div class="meta">Streak: <b>${streak}</b> · Tap squares to log</div>
          </div>
          <div class="actions">
            <button class="primary" data-act="yesterday">Log yesterday</button>
            <button class="danger" data-act="delete">Delete</button>
          </div>
        </div>
        <div class="gridWrap">
          <div class="grid" aria-label="Last ${WINDOW_DAYS} days grid"></div>
        </div>
      `;

      // Actions
      card.querySelector('[data-act="delete"]').onclick = () => {
        if(confirm(`Delete "${habit.name}"?`)){
          state.habits = state.habits.filter(h => h.id !== habit.id);
          save(); render();
        }
      };
      card.querySelector('[data-act="yesterday"]').onclick = () => {
        const d = daysAgo(1);
        openLogModal(habit.id, ymd(d));
      };

      // Grid squares
      const grid = card.querySelector(".grid");
      for(let i = WINDOW_DAYS-1; i >= 0; i--){
        const d = daysAgo(i);
        const key = ymd(d);
        const sq = document.createElement("div");
        sq.className = "sq";
        sq.dataset.date = key;
        sq.dataset.level = String(getLevelForHabitSquare(habit, key));
        if(key === ymd(today)) sq.classList.add("sqToday");
        sq.title = key;
        sq.onclick = () => openLogModal(habit.id, key);
        grid.appendChild(sq);
      }

      gallery.appendChild(card);
    }
  }

  /*** Modals ***/
  document.getElementById("addBtn").addEventListener("click", () => openAddHabitModal());

  function openAddHabitModal(){
    openModal({
      title: "Add habit",
      primaryText: "Add",
      bodyHTML: `
        <div>
          <label>Habit name</label>
          <input id="hName" placeholder="e.g., Water, Workout, Read" maxlength="40" />
        </div>
        <div class="row">
          <div>
            <label>Type</label>
            <select id="hType">
              <option value="yn">Yes / No</option>
              <option value="num">Numeric</option>
            </select>
          </div>
          <div id="targetWrap" style="display:none;">
            <label>Target (optional)</label>
            <input id="hTarget" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 8" />
          </div>
        </div>
      `,
      onPrimary: () => {
        const name = document.getElementById("hName").value.trim();
        const type = document.getElementById("hType").value;
        const targetRaw = document.getElementById("hTarget")?.value;

        if(!name){
          alert("Please enter a habit name.");
          return;
        }
        const target = type === "num" && targetRaw ? Number(targetRaw) : null;
        if(type === "num" && targetRaw && (!Number.isFinite(target) || target < 0)){
          alert("Target must be a valid number.");
          return;
        }

        state.habits.push({
          id: crypto.randomUUID(),
          name,
          type,
          target: type === "num" ? (target ?? null) : null,
          createdAt: Date.now(),
          logs: {},
          notes: {}
        });
        save();
        close();
        render();
      }
    });

    const sel = () => document.getElementById("hType");
    const wrap = () => document.getElementById("targetWrap");
    sel().addEventListener("change", () => {
      wrap().style.display = sel().value === "num" ? "block" : "none";
    });
  }

  function openLogModal(habitId, dateStr){
    const habit = state.habits.find(h => h.id === habitId);
    if(!habit) return;

    const current = habit.logs?.[dateStr];
    const isToday = (dateStr === ymd(today));

    let body = `
      <div>
        <div class="pill" style="display:inline-block;margin-bottom:10px;">${escapeHtml(habit.name)} · ${dateStr}${isToday ? " · today" : ""}</div>
      </div>
    `;

    if(habit.type === "yn"){
      const v = current === true ? "yes" : (current === false ? "no" : "unset");
      body += `
        <div class="row">
          <div>
            <label>Status</label>
            <select id="logYN">
              <option value="unset"${v==="unset"?" selected":""}>—</option>
              <option value="yes"${v==="yes"?" selected":""}>Yes</option>
              <option value="no"${v==="no"?" selected":""}>No</option>
            </select>
          </div>
          <div>
            <label>Quick actions</label>
            <div class="row">
              <button class="primary" type="button" id="btnYes">Yes</button>
              <button type="button" id="btnNo">No</button>
            </div>
          </div>
        </div>
      `;
    } else {
      body += `
        <div>
          <label>Value${habit.target ? ` (target ${habit.target})` : ""}</label>
          <input id="logNum" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="0" value="${current ?? ""}" />
        </div>
      `;
    }

    openModal({
      title: "Log day",
      primaryText: "Save log",
      secondaryText: "Close",
      bodyHTML: body,
      onPrimary: () => {
        if(habit.type === "yn"){
          const sel = document.getElementById("logYN").value;
          if(sel === "unset"){
            delete habit.logs[dateStr];
          }else{
            habit.logs[dateStr] = (sel === "yes");
          }
        } else {
          const raw = document.getElementById("logNum").value;
          if(raw === ""){
            delete habit.logs[dateStr];
          } else {
            const num = Number(raw);
            if(!Number.isFinite(num)){
              alert("Enter a valid number.");
              return;
            }
            habit.logs[dateStr] = num;
          }
        }
        save();
        close();
        render();
      }
    });

    // Wire quick buttons (yn only)
    if(habit.type === "yn"){
      const logYN = document.getElementById("logYN");
      document.getElementById("btnYes").onclick = () => logYN.value = "yes";
      document.getElementById("btnNo").onclick = () => logYN.value = "no";
    }
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  /*** Init ***/
  render();
})();
</script>
</body>
</html>